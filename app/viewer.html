<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    html, body {
      background-color: #222;
      margin: 0;
    }
    pre {
      background-color: white;
      color: black;
    }
  </style>
</head>
<body>
<div style="float:left;">
  <canvas id="c" width="512" height="480"></canvas>
</div>
<div style="float:left; text-align:center;">
  <button onclick="window.pushUp()">Up</button><br/>
  <button onclick="window.pushLeft()">Left</button>
  <button onclick="window.pushRight()">Right</button><br/>
  <button onclick="window.pushDown()">Down</button>
</div>
<div style="float:left; padding: 20px; background-color: white;">
  <pre id="debug"></pre>
</div>
<script src="../lib/level.js"></script>
<script src="../lib/nescolors.js"></script>
<script>
  const colorMap = {
    ' ': NESCOLORS[12],
    '$': NESCOLORS[9],
    '.': NESCOLORS[15],
    '^': NESCOLORS[1],
    'A': NESCOLORS[28]
  };

  // taken from colorthing
  function undoHex(hexChr) {
    const arrayOut = [];

    for(let i = 0; i < 32; i+= 4) {
      const piece = hexChr.slice(i, i + 4);
      const binary = parseInt(piece,16).toString(2).padStart(16,'0');
      for(let j = 0; j < 16; j += 2) {
        const twobit = binary.slice(j, j + 2);
        arrayOut.push(parseInt(twobit,2));
      }
    }

    return arrayOut;
  }

  const palette = [13, 10, 26, 42];
  const blockTopLeft = '15557eaa755565556555651565656555';
  const blockTopRight = '5554a6bd555d55595559555555595559';
  const blockBottomLeft = '65556555655565556555555514040000';
  const blockBottomRight = '55555551555155545540551040440000';
  const blockTopCenter = '5555ab56555555555555555555555555';
  const blockBottomCenter = '55555555555555555555555515040000';
  const blockRightCenter = '55555555555d55595559555555595559';
  const blockInterior = '55555555555555555555555555555555';
  const blockLeftCenter = '65556555755565556555655565556555';

  const letterL = 'a000a400a400a400a400a400aaa81555';
  const letterE = 'aaa8a555a400aaa8a555a400aaa81555';
  const letterV = 'a028a429a429a8a92aa50a9402500040';
  const letterM = 'a028a8a9aaa9aaa9a669a469a4291415';
  const letterO = '2aa0a568a429a429a429a4292aa50554';
  const letterS = '2aa0a568a4052aa00568a0292aa50554';
  const letterI = '2aa8029502900290029002902aa80555';
  const letterT = '2aa80295029002900290029002900050';

  class GRAPHICS {
    constructor() {
      const canvas = document.getElementById('c');
      this.ctx = canvas.getContext('2d');
      this.ctx.scale(2, 2);
    }
    go() {
      this.ctx.fillStyle = NESCOLORS[12];
      this.ctx.fillRect(0,0,256,240);
    }
    drawSprite(which, x, y) {
      const spriteArr = undoHex(which);

      for (let tx = 0; tx < 8; tx++) {
        for (let ty = 0; ty < 8; ty++) {
          const whichColor = spriteArr[(ty * 8) + tx];
          this.ctx.fillStyle = NESCOLORS[palette[whichColor]];
          this.ctx.fillRect(x + tx, y + ty, 1, 1);
        }
      }
    }
    debug(level) {
      const debugEl = document.getElementById('debug');
      let deText = 'LEVEL\n~~~~~\n\n' + level.tiles.map(x => x.map(y => y.padEnd(6, ' ')).join(' | ')).join('\n');
      deText += '\n\n\n\nMETASPRITES\n~~~~~~~~~~~\n\n' + level.metasprites.map(x => x.map(y => y.padEnd(6, ' ')).join(' | ')).join('\n');
      debugEl.innerHTML = deText;
    }
    draw(level) {
      this.debug(level);
      const levelSize = level.tiles.length;
      let howManyA = 0;

      // status bar
      this.ctx.fillStyle = '#000000';
      this.ctx.fillRect(192,0,64,240);

      this.drawSprite(letterL, 200,64);
      this.drawSprite(letterE, 208,64);
      this.drawSprite(letterV, 216,64);
      this.drawSprite(letterE, 224,64);
      this.drawSprite(letterL, 232,64);

      this.drawSprite(letterO, 232,80);

      this.drawSprite(letterM, 200,104);
      this.drawSprite(letterO, 208,104);
      this.drawSprite(letterV, 216,104);
      this.drawSprite(letterE, 224,104);
      this.drawSprite(letterS, 232,104);

      this.drawSprite(letterO, 232,120);

      this.drawSprite(letterI, 200,144);
      this.drawSprite(letterT, 208,144);
      this.drawSprite(letterE, 216,144);
      this.drawSprite(letterM, 224,144);
      this.drawSprite(letterS, 232,144);

      this.drawSprite(letterO, 232,160);

      for (let row = 0; row < levelSize; row++) {
        for (let col = 0; col < levelSize; col++) {
          const tile = level.tiles[row][col];
          this.ctx.fillStyle = colorMap[tile];
          this.ctx.fillRect(16 + (col*16),32 + (row*16),16,16);
          if ((tile === 'A') || (tile === 'B') || (tile === 'C')) {
            const metaInfo = level.metasprites[row][col].split('~')[1];

            // idiomatic, yes. but also idiotic
            const hasU = (metaInfo.indexOf('U') !== -1);
            const hasD = (metaInfo.indexOf('D') !== -1);
            const hasL = (metaInfo.indexOf('L') !== -1);
            const hasR = (metaInfo.indexOf('R') !== -1);
            
            let sprTopLeft = '';
            let sprTopRight = '';
            let sprBottomLeft = '';
            let sprBottomRight = '';

            // top left
            if(hasU && hasL) {
              sprTopLeft = blockTopLeft;
            } else if (!hasU && hasL) {
              sprTopLeft = blockLeftCenter;
            } else if (hasU && !hasL) {
              sprTopLeft = blockTopCenter;
            } else {
              sprTopLeft = blockInterior;
            }

            // top right
            if(hasU && hasR) {
              sprTopRight = blockTopRight;
            } else if (!hasU && hasR) {
              sprTopRight = blockRightCenter;
            } else if (hasU && !hasR) {
              sprTopRight = blockTopCenter;
            } else {
              sprTopRight = blockInterior;
            }

            // bottom left
            if(hasD && hasL) {
              sprBottomLeft = blockBottomLeft;
            } else if (!hasD && hasL) {
              sprBottomLeft = blockLeftCenter;
            } else if (hasD && !hasL) {
              sprBottomLeft = blockBottomCenter;
            } else {
              sprBottomLeft = blockInterior;
            }

            // bottom right
            if(hasD && hasR) {
              sprBottomRight = blockBottomRight;
            } else if (!hasD && hasR) {
              sprBottomRight = blockRightCenter;
            } else if (hasD && !hasR) {
              sprBottomRight = blockBottomCenter;
            } else {
              sprBottomRight = blockInterior;
            }

            this.drawSprite(sprTopLeft, 16 + (col*16), 32 + (row*16));
            this.drawSprite(sprTopRight, 16 + 8 + (col*16), 32 + (row*16));
            this.drawSprite(sprBottomLeft, 16 + (col*16), 32 + 8 + (row*16));
            this.drawSprite(sprBottomRight, 16 + 8 + (col*16), 32 + 8 + (row*16));
          }
        }
      }
    }
  };

  window.pushUp = () => {
    this.l.slideUp();
    this.g.draw(l);
  }

  window.pushLeft = () => {
    this.l.slideLeft();
    this.g.draw(l);
  }

  window.pushRight = () => {
    this.l.slideRight();
    this.g.draw(l);
  }

  window.pushDown = () => {
    this.l.slideDown();
    this.g.draw(l);
  }

  window.onload = () => {
    const s = [
      '..... . A^',
      '......... ',
      '......C$. ',
      '......C.. ',
      '.....B    ',
      '..........',
      '..........',
      '..........',
      '..........',
      '..........',
    ];

    this.l = new LEVEL(s.join('\n'));
    this.g = new GRAPHICS();
    this.g.go();
    this.g.draw(l);
  };
</script>
</body>
</html>
